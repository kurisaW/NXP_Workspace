## spi简介

SPI(串行外设接口)是一种高速全双工，同步通信总线，主要用于短距离传输。

SPI总线通信接口如下：

![SPI 主设备和从设备的连接方式](https://www.rt-thread.org/document/site/rt-thread-version/rt-thread-standard/programming-manual/device/spi/figures/spi1.png)

* SCLK：串行时钟线，主设备输出时钟信号至从设备
* MOSI：主机输出，从机输入数据线
* MISO：主机输入，从机输出数据线
* CS：从设备选择线，主设备输出片选信号至从设备

## 工作原理

spi以主从方式工作，通常有一个主设备和一个或多个从设备。通信由主设备发起，**主设备通过CS选择要通信的从设备，然后通过SCKL给从设备提供时钟信号**，数据通过MOSI输出给从设备，同时通过MISO接收从设备发送的数据。

主设备通过控制CS引脚对从设备进行片选，一般低电平有效。**任何时刻仅有一个CS引脚处于有效状态**，与该有效引脚连接的从设备此时可以与主设备通信。

## 工作时序

从设备的时钟由主设备通过SCLK提供，MISO、MOSI基于此时钟脉冲信号完成数据传输。

SPI的工作时序模式是由**CPOL（Clock Polarity,时钟极性）**和**CPHA(Clock Phase，时钟相位)**之间的相位关系决定。

* CPOL：表示**时钟信号的初始电平的状态**，CPOL为0表示时钟信号初始状态为低电平，为1表示时钟信号的初始电平是高电平。

* CPHA：表示**在哪个时钟沿采样数据**，CPHA为0表示在首个时钟变化沿采样数据，而CPHA为1则表示在第二个时钟变化沿采样数据。

因此CPOL和CPHA可自由组合成四种模式：

```c
(1)  CPOL=0	  CPHA=0
(2)  CPOL=0	  CPHA=1
(3)  CPOL=1	  CPHA=0
(4)  CPOL=1	  CPHA=1
```

| SPI模式 | CPOL | CPHA | 空闲时SCK时钟 | 采样时刻  |
| :-----: | :--: | :--: | :-----------: | :-------: |
|    0    |  0   |  0   |    低电平     | 第1个边沿 |
|    1    |  0   |  1   |    低电平     | 第2个边沿 |
|    2    |  1   |  0   |    高电平     | 第1个边沿 |
|    3    |  1   |  1   |    高电平     | 第2个边沿 |

主从设备必须使用相同的工作模式（SCLK、CPHA、CPOL）才能正常工作。



