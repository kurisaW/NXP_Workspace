#include <rtthread.h>
#include <board.h>
#include <drv_soft_spi.h>
#include "drv_pin.h"
#include <pin_mux.h>

/* 定义SPI总线名称 */
#define OLED_SPI_BUS_NAME       "sspi1"
/* 定义设备名称 */
#define OLED_DEV_NAME           "ssd1306"
#define OLED_CS_PIN             22

#define SSD1306_WIDTH           128
#define SSD1306_HEIGHT          64

#define SSD1306_SET_COL_LOW     0x00
#define SSD1306_SET_COL_HIGH    0x10
#define SSD1306_SET_MEMORY_ADDR 0x20
#define SSD1306_SET_CONTRAST    0x81
#define SSD1306_SEG_REMAP       0xA0
#define SSD1306_DISP_NORMAL     0xA6
#define SSD1306_COM_DIR         0xC0
#define SSD1306_DISP_OFF        0xAE
#define SSD1306_DISP_ON         0xAF

const rt_uint8_t font6x8[][6] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00,// sp
0x00, 0x00, 0x00, 0x2f, 0x00, 0x00,// !
0x00, 0x00, 0x07, 0x00, 0x07, 0x00,// "
0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14,// #
0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12,// $
0x00, 0x62, 0x64, 0x08, 0x13, 0x23,// %
0x00, 0x36, 0x49, 0x55, 0x22, 0x50,// &
0x00, 0x00, 0x05, 0x03, 0x00, 0x00,// '
0x00, 0x00, 0x1c, 0x22, 0x41, 0x00,// (
0x00, 0x00, 0x41, 0x22, 0x1c, 0x00,// )
0x00, 0x14, 0x08, 0x3E, 0x08, 0x14,// *
0x00, 0x08, 0x08, 0x3E, 0x08, 0x08,// +
0x00, 0x00, 0x00, 0xA0, 0x60, 0x00,// ,
0x00, 0x08, 0x08, 0x08, 0x08, 0x08,// -
0x00, 0x00, 0x60, 0x60, 0x00, 0x00,// .
0x00, 0x20, 0x10, 0x08, 0x04, 0x02,// /
0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E,// 0
0x00, 0x00, 0x42, 0x7F, 0x40, 0x00,// 1
0x00, 0x42, 0x61, 0x51, 0x49, 0x46,// 2
0x00, 0x21, 0x41, 0x45, 0x4B, 0x31,// 3
0x00, 0x18, 0x14, 0x12, 0x7F, 0x10,// 4
0x00, 0x27, 0x45, 0x45, 0x45, 0x39,// 5
0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30,// 6
0x00, 0x01, 0x71, 0x09, 0x05, 0x03,// 7
0x00, 0x36, 0x49, 0x49, 0x49, 0x36,// 8
0x00, 0x06, 0x49, 0x49, 0x29, 0x1E,// 9
0x00, 0x00, 0x36, 0x36, 0x00, 0x00,// :
0x00, 0x00, 0x56, 0x36, 0x00, 0x00,// ;
0x00, 0x08, 0x14, 0x22, 0x41, 0x00,// <
0x00, 0x14, 0x14, 0x14, 0x14, 0x14,// =
0x00, 0x00, 0x41, 0x22, 0x14, 0x08,// >
0x00, 0x02, 0x01, 0x51, 0x09, 0x06,// ?
0x00, 0x32, 0x49, 0x59, 0x51, 0x3E,// @
0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C,// A
0x00, 0x7F, 0x49, 0x49, 0x49, 0x36,// B
0x00, 0x3E, 0x41, 0x41, 0x41, 0x22,// C
0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C,// D
0x00, 0x7F, 0x49, 0x49, 0x49, 0x41,// E
0x00, 0x7F, 0x09, 0x09, 0x09, 0x01,// F
0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A,// G
0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F,// H
0x00, 0x00, 0x41, 0x7F, 0x41, 0x00,// I
0x00, 0x20, 0x40, 0x41, 0x3F, 0x01,// J
0x00, 0x7F, 0x08, 0x14, 0x22, 0x41,// K
0x00, 0x7F, 0x40, 0x40, 0x40, 0x40,// L
0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F,// M
0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F,// N
0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E,// O
0x00, 0x7F, 0x09, 0x09, 0x09, 0x06,// P
0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E,// Q
0x00, 0x7F, 0x09, 0x19, 0x29, 0x46,// R
0x00, 0x46, 0x49, 0x49, 0x49, 0x31,// S
0x00, 0x01, 0x01, 0x7F, 0x01, 0x01,// T
0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F,// U
0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F,// V
0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F,// W
0x00, 0x63, 0x14, 0x08, 0x14, 0x63,// X
0x00, 0x07, 0x08, 0x70, 0x08, 0x07,// Y
0x00, 0x61, 0x51, 0x49, 0x45, 0x43,// Z
0x00, 0x00, 0x7F, 0x41, 0x41, 0x00,// [
0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55,// 55
0x00, 0x00, 0x41, 0x41, 0x7F, 0x00,// ]
0x00, 0x04, 0x02, 0x01, 0x02, 0x04,// ^
0x00, 0x40, 0x40, 0x40, 0x40, 0x40,// _
0x00, 0x00, 0x01, 0x02, 0x04, 0x00,// '
0x00, 0x20, 0x54, 0x54, 0x54, 0x78,// a
0x00, 0x7F, 0x48, 0x44, 0x44, 0x38,// b
0x00, 0x38, 0x44, 0x44, 0x44, 0x20,// c
0x00, 0x38, 0x44, 0x44, 0x48, 0x7F,// d
0x00, 0x38, 0x54, 0x54, 0x54, 0x18,// e
0x00, 0x08, 0x7E, 0x09, 0x01, 0x02,// f
0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C,// g
0x00, 0x7F, 0x08, 0x04, 0x04, 0x78,// h
0x00, 0x00, 0x44, 0x7D, 0x40, 0x00,// i
0x00, 0x40, 0x80, 0x84, 0x7D, 0x00,// j
0x00, 0x7F, 0x10, 0x28, 0x44, 0x00,// k
0x00, 0x00, 0x41, 0x7F, 0x40, 0x00,// l
0x00, 0x7C, 0x04, 0x18, 0x04, 0x78,// m
0x00, 0x7C, 0x08, 0x04, 0x04, 0x78,// n
0x00, 0x38, 0x44, 0x44, 0x44, 0x38,// o
0x00, 0xFC, 0x24, 0x24, 0x24, 0x18,// p
0x00, 0x18, 0x24, 0x24, 0x18, 0xFC,// q
0x00, 0x7C, 0x08, 0x04, 0x04, 0x08,// r
0x00, 0x48, 0x54, 0x54, 0x54, 0x20,// s
0x00, 0x04, 0x3F, 0x44, 0x40, 0x20,// t
0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C,// u
0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C,// v
0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C,// w
0x00, 0x44, 0x28, 0x10, 0x28, 0x44,// x
0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C,// y
0x00, 0x44, 0x64, 0x54, 0x4C, 0x44,// z
0x14, 0x14, 0x14, 0x14, 0x14, 0x14,// horiz lines
};

struct rt_spi_device *spi_oled = RT_NULL;

static void ssd1306_write_command(rt_uint8_t cmd)
{
		spi_oled = (struct rt_spi_device *)rt_device_find(OLED_DEV_NAME);
    if (!spi_oled)
    {
        rt_kprintf("spi sample run failed! can't find %s device!\n", OLED_DEV_NAME);
    }
    else
    {
        rt_uint8_t buf[1] = {cmd};
        rt_spi_send_then_send(spi_oled, buf, sizeof(buf), RT_NULL, 0);
    }

}

static void ssd1306_write_data(rt_uint8_t data)
{
	  spi_oled = (struct rt_spi_device *)rt_device_find(OLED_DEV_NAME);
    if (!spi_oled)
    {
        rt_kprintf("spi sample run failed! can't find %s device!\n", OLED_DEV_NAME);
    }
		else
		{
        rt_uint8_t send_buffer[2] = {0x40, data};
				struct rt_spi_message  *send_message = RT_NULL;
				struct rt_spi_message  *recv_message = RT_NULL;
				send_message->send_buf = send_buffer;
				send_message->recv_buf = RT_NULL;
				send_message->length = 2;
				send_message->cs_take = 1;
				send_message->cs_release = 0;
				
				recv_message->send_buf = RT_NULL;
				recv_message->recv_buf = send_buffer;
				recv_message->length = 2;
				recv_message->cs_take = 0;
				recv_message->cs_release = 1;
				
				rt_spi_transfer_message(spi_oled,send_message);
		}

}

static void ssd1306_set_display_pos(rt_uint8_t x_start, rt_uint8_t y_start)
{
    ssd1306_write_command(SSD1306_SET_COL_HIGH | (x_start >> 4 & 0x0f));
    ssd1306_write_command(SSD1306_SET_COL_LOW | (x_start & 0x0f));
    ssd1306_write_command(SSD1306_SET_MEMORY_ADDR);
    ssd1306_write_command(y_start & 0x3f);
}

static void ssd1306_init(void)
{
		rt_err_t result = -RT_ERROR;
		
		result = rt_hw_softspi_device_attach("sspi1","ssd1306",GET_PINS(1,8));
		if(result != RT_ERROR)
		{
			rt_kprintf("sotf_spi device create successful!\n");
		}
	
    /* 关闭OLED显示 */
    ssd1306_write_command(SSD1306_DISP_OFF);
    /* 设置显示偏移，128x64使用32列，0~31列的数据写入时左右反转 */
    ssd1306_write_command(SSD1306_SEG_REMAP);
    /* 设置扫描方向，正常模式 */
    ssd1306_write_command(SSD1306_COM_DIR);
    /* 设置对比度 */
    ssd1306_write_command(SSD1306_SET_CONTRAST);
    ssd1306_write_command(0xCF);

    /* 清屏 */
    ssd1306_set_display_pos(0, 0);
    for (int i = 0; i < SSD1306_WIDTH * SSD1306_HEIGHT / 8; i++)
    {
        ssd1306_write_data(0x00);
    }

    /* 打开OLED显示 */
    ssd1306_write_command(SSD1306_DISP_ON);
}

void oled_show_string(const char *str)
{
    rt_uint8_t x = 2, y = 10;
    while (*str)
    {
        if (x > (SSD1306_WIDTH - 8))
        {
            x = 2;
            y += 10;
        }
        ssd1306_set_display_pos(x, y);

        rt_uint8_t *p = (rt_uint8_t *)font6x8 + ((*str) - ' ') * 6;
        for (int i = 0; i < 6; i++)
        {
            ssd1306_write_data(*p++);
        }

        x += 6;
        str++;
    }
}

static void oled_thread_entry(void *parameter)
{
    ssd1306_init();
    oled_show_string("Hello RT-Thread");
}

int oled_init(void)
{
    rt_thread_t tid;

    tid = rt_thread_create("oled", oled_thread_entry, 
                            RT_NULL, 1024, 25, 10);
    if (tid != RT_NULL)
    {
        rt_thread_startup(tid);
        return RT_EOK;
    }

    return -RT_ERROR;
}

#ifdef RT_USING_FINSH
#include <finsh.h>
void oled_test(void)
{
    oled_init();
}
MSH_CMD_EXPORT(oled_test, OLED ttttt);
#endif